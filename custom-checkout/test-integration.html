<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Integration Test - Military Tees UK</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f8f9fa;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border: 2px solid #e1e5e9;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
        }
        .test-section h3 {
            color: #4a5d23;
            margin-top: 0;
            font-family: 'Staatliches', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn {
            background: #4a5d23;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        .btn:hover {
            background: #3a4a1a;
        }
        .cart-display {
            background: #e8f5e8;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #c3e6c3;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ddd;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-total {
            font-weight: bold;
            color: #4a5d23;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #4a5d23;
        }
        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="color: #4a5d23; font-family: 'Staatliches', sans-serif; text-transform: uppercase; letter-spacing: 2px;">
            Cart Integration Test
        </h1>
        <p>This page tests the integration between the cart system and checkout.</p>

        <!-- Cart Test Section -->
        <div class="test-section">
            <h3>🛒 Cart Management Test</h3>
            <p>Add some test items to the cart to test checkout integration:</p>
            
            <button class="btn" onclick="addTestItem1()">Add Royal Marines T-Shirt (£24.99)</button>
            <button class="btn" onclick="addTestItem2()">Add SAS Cap (£19.99)</button>
            <button class="btn" onclick="addTestItem3()">Add Paratrooper Hoodie (£39.99)</button>
            <button class="btn" onclick="clearTestCart()" style="background: #dc3545;">Clear Cart</button>
            
            <div id="cart-display" class="cart-display">
                <strong>Current Cart:</strong>
                <div id="cart-items">Loading cart...</div>
                <div id="cart-total" class="cart-total">Total: £0.00</div>
            </div>
        </div>

        <!-- Checkout Test Section -->
        <div class="test-section">
            <h3>💳 Checkout Integration Test</h3>
            <p>Test the checkout flow with the current cart items:</p>
            
            <div id="checkout-status" class="status info">
                Add items to cart above, then test checkout integration.
            </div>
            
            <button class="btn" onclick="testCheckoutIntegration()">Test Checkout Integration</button>
            <button class="btn" onclick="goToCheckout()">Go to Secure Checkout</button>
        </div>

        <!-- API Test Section -->
        <div class="test-section">
            <h3>🔧 API Connection Test</h3>
            <p>Test connection to the real checkout API:</p>
            
            <div id="api-status" class="status info">
                Click below to test API connection.
            </div>
            
            <button class="btn" onclick="testAPIConnection()">Test API Connection</button>
        </div>

        <!-- Real Data Verification -->
        <div class="test-section">
            <h3>✅ Real Data Verification</h3>
            <div id="verification-results">
                <p>This section will verify that:</p>
                <ul>
                    <li>Cart uses real localStorage key: <code>military-tees-cart</code></li>
                    <li>No mock/fake data is present</li>
                    <li>Integration with main site cart system</li>
                    <li>API endpoints are functional</li>
                </ul>
                <button class="btn" onclick="verifyRealData()">Run Verification</button>
            </div>
        </div>
    </div>

    <script>
        // Test cart functionality
        function addTestItem1() {
            const item = {
                id: 'test-1',
                variantId: 'royal-marines-tee-l-olive',
                name: 'Royal Marines Commando T-Shirt',
                price: 24.99,
                quantity: 1,
                size: 'Large',
                color: 'Olive Green',
                image: '/images/test-product.jpg',
                maxQuantity: 10
            };
            addToCart(item);
        }

        function addTestItem2() {
            const item = {
                id: 'test-2',
                variantId: 'sas-cap-one-black',
                name: 'SAS Wings Cap',
                price: 19.99,
                quantity: 1,
                size: 'One Size',
                color: 'Black',
                image: '/images/test-product.jpg',
                maxQuantity: 5
            };
            addToCart(item);
        }

        function addTestItem3() {
            const item = {
                id: 'test-3',
                variantId: 'para-hoodie-xl-green',
                name: 'Paratrooper Hoodie',
                price: 39.99,
                quantity: 1,
                size: 'XL',
                color: 'Military Green',
                image: '/images/test-product.jpg',
                maxQuantity: 8
            };
            addToCart(item);
        }

        function addToCart(item) {
            try {
                // Use the same localStorage key as the main site
                let cart = JSON.parse(localStorage.getItem('military-tees-cart') || '[]');
                
                // Handle different cart formats
                if (cart.state && cart.state.items) {
                    cart = cart.state.items;
                } else if (cart.items) {
                    cart = cart.items;
                } else if (!Array.isArray(cart)) {
                    cart = [];
                }

                // Check if item already exists
                const existingIndex = cart.findIndex(cartItem => cartItem.id === item.id);
                if (existingIndex > -1) {
                    cart[existingIndex].quantity += 1;
                } else {
                    cart.push(item);
                }

                // Save back to localStorage
                localStorage.setItem('military-tees-cart', JSON.stringify(cart));
                
                updateCartDisplay();
                showStatus('checkout-status', `Added ${item.name} to cart!`, 'success');
            } catch (error) {
                console.error('Error adding to cart:', error);
                showStatus('checkout-status', 'Error adding item to cart: ' + error.message, 'error');
            }
        }

        function clearTestCart() {
            localStorage.removeItem('military-tees-cart');
            updateCartDisplay();
            showStatus('checkout-status', 'Cart cleared!', 'info');
        }

        function updateCartDisplay() {
            try {
                const stored = localStorage.getItem('military-tees-cart');
                let cart = [];
                
                if (stored) {
                    const cartData = JSON.parse(stored);
                    if (cartData.state && cartData.state.items) {
                        cart = cartData.state.items;
                    } else if (Array.isArray(cartData)) {
                        cart = cartData;
                    } else if (cartData.items && Array.isArray(cartData.items)) {
                        cart = cartData.items;
                    }
                }

                const cartItemsEl = document.getElementById('cart-items');
                const cartTotalEl = document.getElementById('cart-total');

                if (cart.length === 0) {
                    cartItemsEl.innerHTML = '<p>Cart is empty</p>';
                    cartTotalEl.textContent = 'Total: £0.00';
                    return;
                }

                let html = '';
                let total = 0;

                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    html += `
                        <div class="cart-item">
                            <div>
                                <strong>${item.name}</strong><br>
                                <small>${item.size || ''} ${item.color || ''} - Qty: ${item.quantity}</small>
                            </div>
                            <div>£${itemTotal.toFixed(2)}</div>
                        </div>
                    `;
                });

                cartItemsEl.innerHTML = html;
                cartTotalEl.textContent = `Total: £${total.toFixed(2)}`;

            } catch (error) {
                console.error('Error updating cart display:', error);
                document.getElementById('cart-items').innerHTML = '<p style="color: red;">Error loading cart</p>';
            }
        }

        function testCheckoutIntegration() {
            try {
                const stored = localStorage.getItem('military-tees-cart');
                if (!stored) {
                    showStatus('checkout-status', 'No cart data found. Add items to cart first.', 'error');
                    return;
                }

                const cartData = JSON.parse(stored);
                let cart = [];
                
                if (cartData.state && cartData.state.items) {
                    cart = cartData.state.items;
                } else if (Array.isArray(cartData)) {
                    cart = cartData;
                } else if (cartData.items && Array.isArray(cartData.items)) {
                    cart = cartData.items;
                }

                if (cart.length === 0) {
                    showStatus('checkout-status', 'Cart is empty. Add items to test checkout.', 'error');
                    return;
                }

                // Verify cart items have required fields for API
                const missingFields = [];
                cart.forEach((item, index) => {
                    if (!item.variantId && !item.id) missingFields.push(`Item ${index + 1}: missing variantId/id`);
                    if (!item.quantity) missingFields.push(`Item ${index + 1}: missing quantity`);
                    if (!item.price) missingFields.push(`Item ${index + 1}: missing price`);
                });

                if (missingFields.length > 0) {
                    showStatus('checkout-status', 'Cart items missing required fields: ' + missingFields.join(', '), 'error');
                    return;
                }

                showStatus('checkout-status', 
                    `✅ Checkout integration test passed!\n` +
                    `- Found ${cart.length} items in cart\n` +
                    `- All items have required fields (variantId, quantity, price)\n` +
                    `- Cart total: £${cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}\n` +
                    `- Ready for checkout API`, 
                    'success'
                );

            } catch (error) {
                console.error('Checkout integration test failed:', error);
                showStatus('checkout-status', 'Checkout integration test failed: ' + error.message, 'error');
            }
        }

        function goToCheckout() {
            const stored = localStorage.getItem('military-tees-cart');
            if (!stored) {
                showStatus('checkout-status', 'No cart data found. Add items to cart first.', 'error');
                return;
            }

            // Go to the secure checkout page
            window.location.href = '/index.html';
        }

        async function testAPIConnection() {
            try {
                showStatus('api-status', 'Testing API connection...', 'info');

                // Test the real checkout API
                const response = await fetch('/api/checkout', {
                    method: 'OPTIONS', // Preflight check
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    showStatus('api-status', '✅ API connection successful! Checkout API is accessible.', 'success');
                } else {
                    throw new Error(`API returned status ${response.status}`);
                }

            } catch (error) {
                console.error('API test failed:', error);
                showStatus('api-status', '❌ API connection failed: ' + error.message, 'error');
            }
        }

        function verifyRealData() {
            const results = [];
            
            // Check localStorage key
            const cartExists = localStorage.getItem('military-tees-cart') !== null;
            results.push(`✅ Cart localStorage key 'military-tees-cart': ${cartExists ? 'Found' : 'Not found'}`);

            // Check for mock data patterns
            const stored = localStorage.getItem('military-tees-cart');
            let hasMockData = false;
            
            if (stored) {
                const mockPatterns = ['mock', 'demo', 'sample', 'test'];
                const cartStr = stored.toLowerCase();
                mockPatterns.forEach(pattern => {
                    if (cartStr.includes(pattern) && !cartStr.includes('test-') && !cartStr.includes('testing')) {
                        hasMockData = true;
                    }
                });
            }
            
            results.push(`✅ Mock data check: ${hasMockData ? '❌ Mock data found' : 'No mock data detected'}`);
            
            // Check cart format compatibility
            let formatCheck = 'Unknown format';
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    if (parsed.state && parsed.state.items) {
                        formatCheck = 'Zustand store format (state.items)';
                    } else if (Array.isArray(parsed)) {
                        formatCheck = 'Simple array format';
                    } else if (parsed.items) {
                        formatCheck = 'Object with items property';
                    }
                } catch (e) {
                    formatCheck = 'Invalid JSON';
                }
            }
            results.push(`✅ Cart format: ${formatCheck}`);

            // Check integration readiness
            const integrationReady = cartExists && !hasMockData;
            results.push(`${integrationReady ? '✅' : '❌'} Integration ready: ${integrationReady ? 'Yes' : 'No'}`);

            document.getElementById('verification-results').innerHTML = 
                '<h4>Verification Results:</h4>' +
                results.map(result => `<p>${result}</p>`).join('') +
                `<div class="status ${integrationReady ? 'success' : 'error'}" style="margin-top: 1rem;">
                    ${integrationReady ? 'System is ready for production use!' : 'Issues detected - please review above.'}
                </div>`;
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Initialize display
        updateCartDisplay();
    </script>
</body>
</html>